name: OpenAPI Code Generator

on:
  push:
    paths:
      - 'spec/petstore.yaml'
  workflow_dispatch:

permissions:
  contents: write    # To push code
  packages: read     # REQUIRED: To download the jar from GitHub Packages

env:
  GENERATOR_DIR: "generator"
  TEST_OUTPUT_DIR: "generated-code"
  PETSTORE_SPEC: "spec/petstore.yaml"
  CUSTOM_GEN_VERSION: "0.0.1" # Enable debug logging for GitHub Actions

  # Standard CLI URL (Public Maven Central, no auth needed)
  CLI_URL: "https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.17.0/openapi-generator-cli-7.17.0.jar"
  
jobs:
  generate-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Create Generator Directory
        run: mkdir -p ${{ env.GENERATOR_DIR }}

      - name: Download Standard CLI
        run: |
          echo "Downloading OpenAPI Generator CLI..."
          wget -q ${{ env.CLI_URL }} -O ${{ env.GENERATOR_DIR }}/openapi-generator-cli.jar

      - name: Download Custom Generator release asset
        run: |
          mkdir -p bin
          gh release download \
            --repo adamsdavis572/minimal-api-gen \
            --pattern 'aspnet-minimalapi-openapi-generator.jar' \
            --dir ${{ env.GENERATOR_DIR }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: List Downloaded Files
        run: |
          echo "Contents of generator directory:"
          ls -lah ${{ env.GENERATOR_DIR }}
          
      - name: Verify JARs
        run: |
          echo "Checking CLI JAR:"
          file ${{ env.GENERATOR_DIR }}/openapi-generator-cli.jar
          echo "Checking Custom Generator JAR:"
          file ${{ env.GENERATOR_DIR }}/aspnet-minimalapi-openapi-generator.jar

      - name: Generate Server Code
        run: |
          rm -rf ${{ env.TEST_OUTPUT_DIR }}
          
          echo "Generating server code..."
          java -cp "${{ env.GENERATOR_DIR }}/openapi-generator-cli.jar:${{ env.GENERATOR_DIR }}/aspnet-minimalapi-openapi-generator.jar" \
            org.openapitools.codegen.OpenAPIGenerator generate \
            -g aspnetcore-minimalapi \
            -i ${{ env.PETSTORE_SPEC }} \
            -o ${{ env.TEST_OUTPUT_DIR }} \
            -c generator-config.yaml

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ env.TEST_OUTPUT_DIR }}
          if ! git diff --cached --quiet; then
            git commit -m "chore: regenerate openapi code [skip ci]"
            git push
          fi
