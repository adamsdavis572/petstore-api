name: OpenAPI Code Generator

on:
  push:
    paths:
      - 'spec/petstore.yaml'
  workflow_dispatch:

permissions:
  contents: write    # To push code
  packages: read     # REQUIRED: To download the jar from GitHub Packages

env:
  GENERATOR_DIR: "generator"
  TEST_OUTPUT_DIR: "generated-code"
  PETSTORE_SPEC: "spec/petstore.yaml"
  
  ACTIONS_STEP_DEBUG: true
  ACTIONS_RUNNER_DEBUG: true

  # Standard CLI URL (Public Maven Central, no auth needed)
  CLI_URL: "https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.17.0/openapi-generator-cli-7.17.0.jar"
  
  # Custom Generator URL (GitHub Packages)
  # NOTE: Ensure this path is correct. Usually it is https://maven.pkg.github.com/<USER>/<REPO>/<GROUP_PATH>/<ARTIFACT>/<VERSION>/<JAR>
  CUSTOM_GEN_URL: "https://maven.pkg.github.com/adamsdavis572/minimal-api-gen/org/openapitools/aspnet-minimalapi-openapi-generator/0.0.1/aspnet-minimalapi-openapi-generator-0.0.1.jar"

jobs:
  generate-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Create Generator Directory
        run: mkdir -p ${{ env.GENERATOR_DIR }}

      - name: Download Standard CLI
        run: |
          echo "Downloading OpenAPI Generator CLI..."
          wget -q ${{ env.CLI_URL }} -O ${{ env.GENERATOR_DIR }}/openapi-generator-cli.jar

      - name: Download Custom Generator (Authenticated)
        run: |
          echo "Downloading Custom Generator JAR from GitHub Packages..."
          
          # We use curl with the Authorization header. 
          # -L follows redirects
          # -H adds the auth header
          # -o saves to file
          
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "${{ env.CUSTOM_GEN_URL }}" \
            -o ${{ env.GENERATOR_DIR }}/custom-generator.jar
          ls -al ${{ env.GENERATOR_DIR }}

      - name: Debug - List Downloaded Files
        run: |
          echo "Contents of generator directory:"
          ls -lah ${{ env.GENERATOR_DIR }}
          
      - name: Debug - Verify JARs
        run: |
          echo "Checking CLI JAR:"
          file ${{ env.GENERATOR_DIR }}/openapi-generator-cli.jar
          echo "Checking Custom Generator JAR:"
          file ${{ env.GENERATOR_DIR }}/custom-generator.jar

      - name: Debug - Environment Variables
        run: env | sort

      - name: Generate Server Code
        run: |
          rm -rf ${{ env.TEST_OUTPUT_DIR }}
          
          echo "Generating server code..."
          # Using the config file approach (create dummy config for demo)
          echo '{"packageName":"PetstoreApi","useMediatr":true,"useValidators":true}' > generator-config.json

          java -cp "${{ env.GENERATOR_DIR }}/openapi-generator-cli.jar:${{ env.GENERATOR_DIR }}/custom-generator.jar" \
            org.openapitools.codegen.OpenAPIGenerator generate \
            -g aspnetcore-minimalapi \
            -i ${{ env.PETSTORE_SPEC }} \
            -o ${{ env.TEST_OUTPUT_DIR }} \
            -c generator-config.json

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ env.TEST_OUTPUT_DIR }}
          if ! git diff --cached --quiet; then
            git commit -m "chore: regenerate openapi code [skip ci]"
            git push
          fi
